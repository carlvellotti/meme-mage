# Tech Spec: MemeSelectorV2 Caption Generation Refinements (July 2024)

**Author:** AI Assistant (via User Request)
**Date:** July 26, 2024
**Status:** Implemented

## 1. Goals

*   **Prioritize High-Performing Models:** Focus caption generation efforts on the models identified as producing better results (Anthropic Sonnet 3.5 and 3.7), while keeping other models (Gemini 2.5 Pro, Grok 3) available but commented out for easy reactivation if needed.
*   **Increase Caption Diversity:** Allow users to optionally select a *second* set of caption generation rules alongside the primary (default or custom) set.
*   **Conditional Generation Logic:**
    *   If only one rule set is selected, generate 5 captions per model (Sonnet 3.5, Sonnet 3.7) using that rule set.
    *   If two rule sets are selected, generate 5 captions per model *for each* rule set (total 10 captions per model), applying both rule strategies simultaneously.
*   **Clear Result Association:** Visually distinguish which captions were generated by which rule set in the results display.

## 2. Technical Approach

This section outlines the implemented changes primarily within the `src/app/components/MemeSelectorV2.tsx` component.

### 2.1 State Management

*   **New State Variable:** Introduced `selectedRuleSetId2: string` to store the ID of the *optional* second caption rule set. Initialized to `''` (representing "None").
*   **LocalStorage Persistence:** Added a new localStorage key (`memeSelectorV2_selectedRuleSetId2`) to save and load the user's selection for the second rule set.

### 2.2 UI Modifications

*   **Second Rule Set Dropdown:** Added a new `<select>` element to the main form for selecting the optional second rule set, including a "None" option and mirroring the behavior of the primary rule set selector.

### 2.3 Data Structures

*   **`ModelGenerationAttempt` Interface:** Introduced to represent a single generation attempt for a model using a specific rule set. Stores `ruleSetId`, `ruleSetName`, `captions`, `error`, and `latency`.
*   **`ModelCaptionData` Interface:** Introduced to hold all generation attempts for a single model. Stores `modelId` and an array of `generationAttempts`.
*   **`MemeOption` Interface:** Modified `modelCaptions` property to be an array of `ModelCaptionData`.
*   **`CaptionGenerationResult` Interface:** Modified (for internal use during generation) to include `ruleSetId` and `ruleSetName` to track the origin of the result.

### 2.4 Caption Generation Logic (`generateCaptionsForAllTemplates`)

*   **Model Filtering:** Commented out `'google-gemini-2.5-pro'` and `'grok-3-latest'` in the `models` array.
*   **Rule Text & Name Retrieval:** Retrieves text and names for both the primary (`selectedRuleSetId`) and optional secondary (`selectedRuleSetId2`) rule sets. Handles default/none cases.
*   **API Call Loop Modification:**
    *   Iterates through the remaining `models` (Sonnet 3.5, 3.7).
    *   For each `template` and `modelId`:
        *   Creates and dispatches a `fetch` promise (`promise1`) using the primary rule set details (prompt, ID, name).
        *   **Conditional Second Call:** If a secondary rule set is selected and its details are valid, creates and dispatches a *second* `fetch` promise (`promise2`) using the secondary rule set details.
    *   Both promises resolve to a `CaptionGenerationResult` object containing the respective rule set identifiers.
*   **Result Processing (`Promise.allSettled`):**
    *   When iterating through the `results`:
    *   If a promise is fulfilled, extracts the full `CaptionGenerationResult` including `ruleSetId` and `ruleSetName`.
    *   Finds the corresponding `templateIndex` and `modelIndex` in the `finalOptions` array.
    *   Creates a new `ModelGenerationAttempt` object using the result data.
    *   **Pushes Attempt:** Pushes the `newAttempt` object onto the `generationAttempts` array of the corresponding `modelCaption` data structure (`finalOptions[templateIndex].modelCaptions[modelIndex].generationAttempts.push(newAttempt)`). This naturally groups results by the rule set that generated them.

### 2.5 Result Display

*   **Nested Looping:** The rendering logic now includes an outer loop iterating through `modelCaption.generationAttempts` for each model.
*   **Rule Set Subheader:** Inside this loop, an `<h5>` subheader is rendered displaying the `attempt.ruleSetName` and its associated `latency`.
*   **Grouped Captions:** Below the subheader, the captions (`attempt.captions`) for that specific rule set attempt are rendered.
*   **Numbering:** The caption numbering (`index + 1`) is now relative to each rule set group (1-5).

### 2.6 Logging

*   Enhanced `console.log` statements at the start of `generateCaptionsForAllTemplates` to explicitly state which rule sets (Primary and Optional Secondary, or just Primary) are being used.

### 2.7 Known Issues / Notes

*   **Persistent Linter Error:** A TypeScript linter error (`'secondarySystemPrompt' is possibly 'null'`) persists on the `console.log` line used for debugging the secondary system prompt within the `if (secondaryRulesText)` block (Line ~255). Despite multiple attempts at type narrowing ( `typeof` checks, assignment to constants within the block, explicit `null` checks), the type checker does not seem to recognize that the variable cannot be null at that point due to the outer `if` condition. Given the code appears functional and this log is primarily for debugging, the decision was made to proceed without resolving this specific linter warning for now. It may require further refactoring or a `// @ts-ignore` if it becomes problematic during deployment or further development.
*   **`convertToSelectedMemeFormat`:** The utility function that prepares data for the `MemeGenerator` component currently flattens captions from all rule sets. This might need revisiting if `MemeGenerator` requires more structured data in the future. 